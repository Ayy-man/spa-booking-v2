<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Connection Test</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="min-h-screen bg-background py-8">
        <div class="container mx-auto px-4">
            <h1 class="text-4xl font-heading text-primary-dark mb-8 text-center">
                Database Connection Test
            </h1>
            
            <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                <h2 class="text-2xl font-heading text-primary-dark mb-4">Connection Status</h2>
                <div id="connection-status" class="p-4 rounded-lg">
                    <p>Testing connection...</p>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                <h2 class="text-2xl font-heading text-primary-dark mb-4">Services Data</h2>
                <div id="services-data">
                    <p>Loading services...</p>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                <h2 class="text-2xl font-heading text-primary-dark mb-4">Staff Data</h2>
                <div id="staff-data">
                    <p>Loading staff...</p>
                </div>
            </div>

            <div class="text-center">
                <button id="test-functions-btn" class="btn-primary">
                    Test Database Functions
                </button>
            </div>
        </div>
    </div>

    <script src="js/supabase-config.js"></script>
    <script>
        async function testDatabase() {
            const statusDiv = document.getElementById('connection-status');
            const servicesDiv = document.getElementById('services-data');
            const staffDiv = document.getElementById('staff-data');

            try {
                // Test connection
                const connectionTest = await SupabaseAPI.testConnection();
                if (connectionTest.success) {
                    statusDiv.innerHTML = `
                        <div style="color: #059669; background-color: #ECFDF5; padding: 1rem; border-radius: 8px;">
                            ✅ Database connected successfully!<br>
                            Services in database: ${connectionTest.serviceCount || 'Unknown'}
                        </div>
                    `;
                } else {
                    throw new Error(connectionTest.error);
                }

                // Test services loading
                const services = await SupabaseAPI.getServices();
                servicesDiv.innerHTML = `
                    <div style="color: #059669;">
                        ✅ Loaded ${services.length} services
                    </div>
                    <div style="margin-top: 1rem; max-height: 200px; overflow-y: auto;">
                        ${services.map(service => 
                            `<div style="padding: 0.25rem; border-bottom: 1px solid #E5E7EB;">
                                <strong>${service.name}</strong> - $${service.price} (${service.duration} min) - ${service.category}
                            </div>`
                        ).join('')}
                    </div>
                `;

                // Test staff loading
                const staff = await SupabaseAPI.getStaff();
                staffDiv.innerHTML = `
                    <div style="color: #059669;">
                        ✅ Loaded ${staff.length} staff members
                    </div>
                    <div style="margin-top: 1rem;">
                        ${staff.map(member => 
                            `<div style="padding: 0.5rem; border-bottom: 1px solid #E5E7EB;">
                                <strong>${member.name}</strong> (${member.initials})<br>
                                <small>Capabilities: ${member.capabilities.join(', ')}</small><br>
                                <small>Works: ${member.work_days.map(day => ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][day]).join(', ')}</small>
                            </div>`
                        ).join('')}
                    </div>
                `;

            } catch (error) {
                console.error('Database test failed:', error);
                statusDiv.innerHTML = `
                    <div style="color: #DC2626; background-color: #FEF2F2; padding: 1rem; border-radius: 8px;">
                        ❌ Database connection failed:<br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // Test advanced functions
        document.getElementById('test-functions-btn').addEventListener('click', async function() {
            try {
                // Test availability check
                const facialStaff = await SupabaseAPI.getAvailableStaff('facials', new Date());
                console.log('Available facial staff:', facialStaff);

                // Test customer lookup
                const testCustomer = await SupabaseAPI.findCustomerByEmail('test@example.com');
                console.log('Customer lookup result:', testCustomer);

                alert('Function tests completed! Check browser console for results.');
            } catch (error) {
                console.error('Function test error:', error);
                alert('Function test failed: ' + error.message);
            }
        });

        // Run tests when page loads
        document.addEventListener('DOMContentLoaded', testDatabase);
    </script>
</body>
</html>