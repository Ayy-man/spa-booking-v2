<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Booking Flow Test - Dermal Skin Clinic</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #d4f8d4; border-color: #4caf50; }
        .error { background: #ffebee; border-color: #f44336; }
        .loading { background: #fff8e1; border-color: #ff9800; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .service-card { border: 1px solid #ddd; padding: 15px; margin: 10px; border-radius: 8px; cursor: pointer; }
        .service-card:hover { background: #f5f5f5; }
        .staff-card { border: 1px solid #ddd; padding: 10px; margin: 5px; border-radius: 5px; }
        h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .result { padding: 10px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üéØ End-to-End Booking Flow Test</h1>
    <p>This tests the complete booking flow that was previously failing with "no staff available"</p>
    
    <button onclick="runCompleteTest()">üöÄ Test Complete Booking Flow</button>
    <button onclick="testSpecificService('waxing')">üîç Test Waxing (Previously Failing)</button>
    <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
    
    <div id="results"></div>

    <!-- Include Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>

    <script>
        const resultsDiv = document.getElementById('results');

        function addResult(title, content, type = 'loading') {
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = `<h3>${title}</h3>${content}`;
            resultsDiv.appendChild(div);
            return div;
        }

        function clearResults() {
            resultsDiv.innerHTML = '';
        }

        async function runCompleteTest() {
            clearResults();
            const startTime = Date.now();
            
            addResult('üöÄ Starting Complete Booking Flow Test', 'Testing the full booking process that was previously broken...', 'loading');

            try {
                // Step 1: Load Services (Service Selection Page)
                const servicesDiv = addResult('Step 1: Service Selection', 'Loading available services...', 'loading');
                const services = await SupabaseAPI.getServices();
                
                if (services.length === 0) {
                    servicesDiv.className = 'test-section error';
                    servicesDiv.innerHTML = '<h3>‚ùå Step 1 Failed</h3>No services found in database';
                    return;
                }

                let servicesHtml = `<p>‚úÖ Found ${services.length} services</p>`;
                servicesHtml += '<div style="max-height: 200px; overflow-y: auto;">';
                
                // Group by category
                const servicesByCategory = {};
                services.forEach(service => {
                    if (!servicesByCategory[service.category]) {
                        servicesByCategory[service.category] = [];
                    }
                    servicesByCategory[service.category].push(service);
                });

                Object.keys(servicesByCategory).forEach(category => {
                    servicesHtml += `<h4>${category.toUpperCase()}: ${servicesByCategory[category].length} services</h4>`;
                });
                servicesHtml += '</div>';

                servicesDiv.className = 'test-section success';
                servicesDiv.innerHTML = `<h3>‚úÖ Step 1: Service Selection</h3>${servicesHtml}`;

                // Step 2: Test Staff Availability for Each Category
                const staffDiv = addResult('Step 2: Staff Availability Check', 'Checking staff availability for all service categories...', 'loading');
                
                const testDate = new Date().toISOString().split('T')[0];
                const categoryResults = {};
                
                for (const category of Object.keys(servicesByCategory)) {
                    try {
                        const availableStaff = await SupabaseAPI.getAvailableStaffOptimized(category, testDate);
                        categoryResults[category] = {
                            success: true,
                            count: availableStaff.length,
                            staff: availableStaff.map(s => s.name)
                        };
                    } catch (error) {
                        categoryResults[category] = {
                            success: false,
                            error: error.message
                        };
                    }
                }

                let staffHtml = `<p>Testing date: ${testDate}</p>`;
                let allCategoriesWorking = true;

                Object.keys(categoryResults).forEach(category => {
                    const result = categoryResults[category];
                    if (result.success) {
                        staffHtml += `<div class="result" style="background: #d4f8d4;">`;
                        staffHtml += `<strong>‚úÖ ${category}:</strong> ${result.count} staff available`;
                        if (result.count > 0) {
                            staffHtml += ` (${result.staff.join(', ')})`;
                        }
                        staffHtml += `</div>`;
                    } else {
                        staffHtml += `<div class="result" style="background: #ffebee;">`;
                        staffHtml += `<strong>‚ùå ${category}:</strong> ${result.error}`;
                        staffHtml += `</div>`;
                        allCategoriesWorking = false;
                    }
                });

                staffDiv.className = allCategoriesWorking ? 'test-section success' : 'test-section error';
                staffDiv.innerHTML = `<h3>${allCategoriesWorking ? '‚úÖ' : '‚ùå'} Step 2: Staff Availability</h3>${staffHtml}`;

                // Step 3: Test Problematic Service (Waxing)
                const waxingDiv = addResult('Step 3: Waxing Service Test', 'Testing the previously failing waxing service...', 'loading');
                
                try {
                    const waxingStaff = await SupabaseAPI.getAvailableStaffOptimized('waxing', testDate);
                    const waxingServices = servicesByCategory['waxing'] || [];
                    
                    let waxingHtml = `<p><strong>Waxing Services:</strong> ${waxingServices.length} available</p>`;
                    waxingHtml += `<p><strong>Available Staff:</strong> ${waxingStaff.length} qualified</p>`;
                    
                    if (waxingStaff.length > 0) {
                        waxingHtml += '<ul>';
                        waxingStaff.forEach(staff => {
                            waxingHtml += `<li><strong>${staff.name}</strong> - ${staff.specialties}</li>`;
                        });
                        waxingHtml += '</ul>';
                        
                        waxingDiv.className = 'test-section success';
                        waxingDiv.innerHTML = `<h3>üéâ Step 3: Waxing Service Fixed!</h3>${waxingHtml}`;
                    } else {
                        waxingHtml += '<p>‚ö†Ô∏è No staff available (may be due to schedule/day constraints)</p>';
                        waxingDiv.className = 'test-section error';
                        waxingDiv.innerHTML = `<h3>‚ö†Ô∏è Step 3: No Waxing Staff</h3>${waxingHtml}`;
                    }
                } catch (error) {
                    waxingDiv.className = 'test-section error';
                    waxingDiv.innerHTML = `<h3>‚ùå Step 3: Waxing Test Failed</h3><p>Error: ${error.message}</p>`;
                }

                // Final Summary
                const duration = Date.now() - startTime;
                const summaryDiv = addResult('üèÅ Test Summary', '', 'loading');
                
                let summaryHtml = `<p><strong>Test Duration:</strong> ${duration}ms</p>`;
                summaryHtml += `<p><strong>Services Loaded:</strong> ${services.length}</p>`;
                summaryHtml += `<p><strong>Categories Working:</strong> ${Object.values(categoryResults).filter(r => r.success).length}/${Object.keys(categoryResults).length}</p>`;
                
                if (allCategoriesWorking) {
                    summaryHtml += '<p style="color: green; font-weight: bold; font-size: 1.2em;">üéâ BOOKING SYSTEM FULLY OPERATIONAL!</p>';
                    summaryHtml += '<p>The "no staff available" issue has been completely resolved.</p>';
                    summaryDiv.className = 'test-section success';
                } else {
                    summaryHtml += '<p style="color: orange; font-weight: bold;">‚ö†Ô∏è Some issues remain, but core functionality is working.</p>';
                    summaryDiv.className = 'test-section error';
                }

                summaryDiv.innerHTML = `<h3>üèÅ Test Complete</h3>${summaryHtml}`;

            } catch (error) {
                addResult('‚ùå Test Failed', `Critical error: ${error.message}`, 'error');
                console.error('Complete test error:', error);
            }
        }

        async function testSpecificService(serviceCategory) {
            clearResults();
            
            const testDiv = addResult(`üîç Testing ${serviceCategory.toUpperCase()} Service`, 'Running detailed test...', 'loading');
            
            try {
                const testDate = new Date().toISOString().split('T')[0];
                
                // Get services in this category
                const allServices = await SupabaseAPI.getServices();
                const categoryServices = allServices.filter(s => s.category === serviceCategory);
                
                // Get available staff
                const availableStaff = await SupabaseAPI.getAvailableStaffOptimized(serviceCategory, testDate);
                
                let html = `<p><strong>Date:</strong> ${testDate}</p>`;
                html += `<p><strong>Services in ${serviceCategory}:</strong> ${categoryServices.length}</p>`;
                html += `<p><strong>Available Staff:</strong> ${availableStaff.length}</p>`;
                
                if (categoryServices.length > 0) {
                    html += '<h4>Available Services:</h4><ul>';
                    categoryServices.slice(0, 5).forEach(service => {
                        html += `<li>${service.name} - $${service.price} (${service.duration} min)</li>`;
                    });
                    if (categoryServices.length > 5) {
                        html += `<li>... and ${categoryServices.length - 5} more</li>`;
                    }
                    html += '</ul>';
                }
                
                if (availableStaff.length > 0) {
                    html += '<h4>Available Staff:</h4><ul>';
                    availableStaff.forEach(staff => {
                        html += `<li><strong>${staff.name}</strong> - ${staff.specialties}</li>`;
                    });
                    html += '</ul>';
                    
                    testDiv.className = 'test-section success';
                    testDiv.innerHTML = `<h3>‚úÖ ${serviceCategory.toUpperCase()} Service Working!</h3>${html}`;
                } else {
                    html += '<p>‚ö†Ô∏è No staff available for this service on the selected date.</p>';
                    testDiv.className = 'test-section error';
                    testDiv.innerHTML = `<h3>‚ö†Ô∏è No Staff Available</h3>${html}`;
                }
                
            } catch (error) {
                testDiv.className = 'test-section error';
                testDiv.innerHTML = `<h3>‚ùå ${serviceCategory.toUpperCase()} Test Failed</h3><p>Error: ${error.message}</p>`;
            }
        }

        // Auto-run test on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                runCompleteTest();
            }, 1000);
        });
    </script>
</body>
</html>