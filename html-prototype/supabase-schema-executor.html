<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dermal Skin Clinic - Database Schema Executor</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #2d3748;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #718096;
            font-size: 16px;
        }
        
        .config-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }
        
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }
        
        .btn {
            background: #3182ce;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-right: 10px;
            transition: background-color 0.2s;
        }
        
        .btn:hover {
            background: #2c5aa0;
        }
        
        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }
        
        .btn-success {
            background: #38a169;
        }
        
        .btn-success:hover {
            background: #2f855a;
        }
        
        .log-container {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            white-space: pre-wrap;
        }
        
        .success {
            color: #68d391;
        }
        
        .error {
            color: #fc8181;
        }
        
        .warning {
            color: #faf089;
        }
        
        .info {
            color: #63b3ed;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #3182ce;
            width: 0%;
            transition: width 0.3s;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .stat-label {
            color: #718096;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Dermal Skin Clinic Database Setup</h1>
            <p>Execute the corrected schema with proper RLS policies</p>
        </div>
        
        <div class="config-section">
            <h3>Supabase Configuration</h3>
            <div class="form-group">
                <label for="supabaseUrl">Supabase URL</label>
                <input type="text" id="supabaseUrl" value="https://doradsvnphdwotkeiylv.supabase.co" placeholder="https://your-project.supabase.co">
            </div>
            <div class="form-group">
                <label for="serviceRoleKey">Service Role Key (for admin operations)</label>
                <input type="password" id="serviceRoleKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                <small style="color: #718096; font-size: 12px;">
                    Find this in Supabase Dashboard ‚Üí Settings ‚Üí API ‚Üí service_role key
                </small>
            </div>
        </div>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <button class="btn" onclick="executeSchema()" id="executeBtn">
                üöÄ Execute Schema
            </button>
            <button class="btn btn-success" onclick="verifySchema()" id="verifyBtn">
                üîç Verify Schema
            </button>
            <button class="btn" onclick="clearLog()" style="background: #718096;">
                üóëÔ∏è Clear Log
            </button>
        </div>
        
        <div class="progress-bar" id="progressBar" style="display: none;">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div class="log-container" id="logContainer">
            <div class="info">üìù Ready to execute schema. Please enter your Supabase configuration above.</div>
        </div>
        
        <div class="stats" id="statsContainer" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="servicesCount">0</div>
                <div class="stat-label">Services</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="staffCount">0</div>
                <div class="stat-label">Staff Members</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="roomsCount">0</div>
                <div class="stat-label">Rooms</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="tablesCount">0</div>
                <div class="stat-label">Tables Created</div>
            </div>
        </div>
    </div>

    <script>
        let supabase = null;
        
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            const logElement = document.createElement('div');
            logElement.className = type;
            logElement.textContent = logEntry;
            
            logContainer.appendChild(logElement);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
            log('Log cleared', 'info');
        }
        
        function updateProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            if (percent > 0) {
                progressBar.style.display = 'block';
                progressFill.style.width = percent + '%';
            } else {
                progressBar.style.display = 'none';
            }
        }
        
        function initializeSupabase() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('serviceRoleKey').value;
            
            if (!url || !key) {
                log('‚ùå Please provide both Supabase URL and Service Role Key', 'error');
                return false;
            }
            
            try {
                supabase = window.supabase.createClient(url, key);
                log('‚úÖ Supabase client initialized successfully', 'success');
                return true;
            } catch (error) {
                log(`‚ùå Failed to initialize Supabase client: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function executeSchema() {
            if (!initializeSupabase()) return;
            
            const executeBtn = document.getElementById('executeBtn');
            executeBtn.disabled = true;
            executeBtn.textContent = '‚è≥ Executing...';
            
            log('üöÄ Starting schema execution for Dermal Skin Clinic...', 'info');
            
            try {
                // Define the schema sections to execute
                const schemaSections = [
                    {
                        name: 'Extensions and Types',
                        sql: `
                        CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
                        CREATE EXTENSION IF NOT EXISTS "pgcrypto";
                        
                        CREATE TYPE service_category AS ENUM (
                            'facials', 'massages', 'treatments', 'waxing', 'packages', 'special'
                        );
                        
                        CREATE TYPE booking_status AS ENUM (
                            'pending', 'confirmed', 'checked_in', 'in_progress', 'completed', 'cancelled', 'no_show'
                        );
                        
                        CREATE TYPE payment_status AS ENUM (
                            'pending', 'partial', 'paid', 'refunded', 'voided'
                        );
                        
                        CREATE TYPE staff_role AS ENUM (
                            'therapist', 'receptionist', 'manager', 'admin'
                        );
                        `
                    },
                    {
                        name: 'Core Tables',
                        sql: `
                        CREATE TABLE IF NOT EXISTS services (
                            id TEXT PRIMARY KEY,
                            name TEXT NOT NULL,
                            description TEXT,
                            category service_category NOT NULL,
                            duration INTEGER NOT NULL CHECK (duration > 0),
                            price DECIMAL(10,2) NOT NULL CHECK (price >= 0),
                            requires_room_3 BOOLEAN DEFAULT FALSE,
                            is_couples_service BOOLEAN DEFAULT FALSE,
                            is_active BOOLEAN DEFAULT TRUE,
                            service_capabilities TEXT[] DEFAULT '{}',
                            created_at TIMESTAMPTZ DEFAULT NOW(),
                            updated_at TIMESTAMPTZ DEFAULT NOW()
                        );
                        
                        CREATE TABLE IF NOT EXISTS rooms (
                            id INTEGER PRIMARY KEY,
                            name TEXT NOT NULL,
                            capacity INTEGER NOT NULL CHECK (capacity > 0),
                            capabilities service_category[] NOT NULL DEFAULT '{}',
                            equipment TEXT[] DEFAULT '{}',
                            features TEXT[] DEFAULT '{}',
                            is_active BOOLEAN DEFAULT TRUE,
                            created_at TIMESTAMPTZ DEFAULT NOW(),
                            updated_at TIMESTAMPTZ DEFAULT NOW()
                        );
                        
                        CREATE TABLE IF NOT EXISTS staff (
                            id TEXT PRIMARY KEY,
                            name TEXT NOT NULL,
                            email TEXT UNIQUE,
                            phone TEXT,
                            specialties TEXT,
                            capabilities service_category[] NOT NULL DEFAULT '{}',
                            work_days INTEGER[] NOT NULL DEFAULT '{}',
                            default_room_id INTEGER REFERENCES rooms(id),
                            role staff_role DEFAULT 'therapist',
                            initials TEXT,
                            hourly_rate DECIMAL(10,2),
                            is_active BOOLEAN DEFAULT TRUE,
                            auth_user_id UUID,
                            created_at TIMESTAMPTZ DEFAULT NOW(),
                            updated_at TIMESTAMPTZ DEFAULT NOW()
                        );
                        
                        CREATE TABLE IF NOT EXISTS customers (
                            id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
                            first_name TEXT NOT NULL,
                            last_name TEXT NOT NULL,
                            email TEXT UNIQUE,
                            phone TEXT NOT NULL,
                            date_of_birth DATE,
                            address TEXT,
                            city TEXT,
                            postal_code TEXT,
                            emergency_contact_name TEXT,
                            emergency_contact_phone TEXT,
                            medical_conditions TEXT,
                            allergies TEXT,
                            skin_type TEXT,
                            preferences JSONB DEFAULT '{}',
                            notes TEXT,
                            total_visits INTEGER DEFAULT 0,
                            total_spent DECIMAL(10,2) DEFAULT 0,
                            last_visit_date TIMESTAMPTZ,
                            marketing_consent BOOLEAN DEFAULT FALSE,
                            is_active BOOLEAN DEFAULT TRUE,
                            auth_user_id UUID,
                            created_at TIMESTAMPTZ DEFAULT NOW(),
                            updated_at TIMESTAMPTZ DEFAULT NOW()
                        );
                        
                        CREATE TABLE IF NOT EXISTS bookings (
                            id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
                            customer_id UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
                            service_id TEXT NOT NULL REFERENCES services(id),
                            staff_id TEXT NOT NULL REFERENCES staff(id),
                            room_id INTEGER NOT NULL REFERENCES rooms(id),
                            appointment_date DATE NOT NULL,
                            start_time TIME NOT NULL,
                            end_time TIME NOT NULL,
                            duration INTEGER NOT NULL,
                            total_price DECIMAL(10,2) NOT NULL,
                            discount DECIMAL(10,2) DEFAULT 0,
                            final_price DECIMAL(10,2) NOT NULL,
                            status booking_status DEFAULT 'pending',
                            payment_status payment_status DEFAULT 'pending',
                            notes TEXT,
                            internal_notes TEXT,
                            created_by TEXT,
                            checked_in_at TIMESTAMPTZ,
                            completed_at TIMESTAMPTZ,
                            cancelled_at TIMESTAMPTZ,
                            cancellation_reason TEXT,
                            created_at TIMESTAMPTZ DEFAULT NOW(),
                            updated_at TIMESTAMPTZ DEFAULT NOW(),
                            CONSTRAINT valid_time_range CHECK (end_time > start_time),
                            CONSTRAINT valid_price CHECK (final_price >= 0),
                            CONSTRAINT valid_discount CHECK (discount >= 0 AND discount <= total_price)
                        );
                        `
                    }
                ];
                
                let completed = 0;
                const total = schemaSections.length + 1; // +1 for data insertion
                
                // Execute schema sections
                for (const section of schemaSections) {
                    log(`‚è≥ Executing: ${section.name}...`, 'info');
                    
                    const { error } = await supabase.rpc('execute_sql', {
                        query: section.sql
                    });
                    
                    if (error) {
                        log(`‚ùå Error in ${section.name}: ${error.message}`, 'error');
                    } else {
                        log(`‚úÖ ${section.name} completed successfully`, 'success');
                    }
                    
                    completed++;
                    updateProgress((completed / total) * 100);
                    
                    // Small delay to prevent rate limiting
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // Insert initial data
                await insertInitialData();
                completed++;
                updateProgress((completed / total) * 100);
                
                log('üéâ Schema execution completed!', 'success');
                
                // Verify the results
                await verifySchema();
                
            } catch (error) {
                log(`üí• Fatal error during schema execution: ${error.message}`, 'error');
            } finally {
                executeBtn.disabled = false;
                executeBtn.textContent = 'üöÄ Execute Schema';
                updateProgress(0);
            }
        }
        
        async function insertInitialData() {
            log('üìä Inserting initial data...', 'info');
            
            try {
                // Insert rooms
                const { error: roomsError } = await supabase
                    .from('rooms')
                    .upsert([
                        { id: 1, name: 'Room 1', capacity: 1, capabilities: ['facials', 'waxing'] },
                        { id: 2, name: 'Room 2', capacity: 2, capabilities: ['facials', 'waxing', 'massages', 'packages'] },
                        { id: 3, name: 'Room 3', capacity: 2, capabilities: ['facials', 'waxing', 'massages', 'treatments', 'packages', 'special'] }
                    ]);
                
                if (roomsError) {
                    log(`‚ùå Error inserting rooms: ${roomsError.message}`, 'error');
                } else {
                    log('‚úÖ Rooms data inserted successfully', 'success');
                }
                
                // Insert staff
                const { error: staffError } = await supabase
                    .from('staff')
                    .upsert([
                        {
                            id: 'any',
                            name: 'Any Available Staff',
                            specialties: 'Any qualified staff member',
                            capabilities: ['facials', 'massages', 'treatments', 'waxing', 'packages', 'special'],
                            work_days: [0,1,2,3,4,5,6],
                            initials: 'AA'
                        },
                        {
                            id: 'selma',
                            name: 'Selma Villaver',
                            email: 'happyskinhappyyou@gmail.com',
                            phone: '(671) 482-7765',
                            specialties: 'All Facials (except dermaplaning)',
                            capabilities: ['facials'],
                            work_days: [1,3,5,6,0],
                            default_room_id: 1,
                            initials: 'SV'
                        },
                        {
                            id: 'robyn',
                            name: 'Robyn Camacho',
                            email: 'robyncmcho@gmail.com',
                            phone: '(671) 480-7862',
                            specialties: 'Facials, Waxing, Body Treatments, Massages',
                            capabilities: ['facials', 'waxing', 'treatments', 'massages', 'packages', 'special'],
                            work_days: [0,1,2,3,4,5,6],
                            default_room_id: 3,
                            initials: 'RC'
                        },
                        {
                            id: 'tanisha',
                            name: 'Tanisha Harris',
                            email: 'misstanishababyy@gmail.com',
                            phone: '(671) 747-5728',
                            specialties: 'Facials and Waxing',
                            capabilities: ['facials', 'waxing'],
                            work_days: [1,3,5,6,0],
                            default_room_id: 2,
                            initials: 'TH'
                        },
                        {
                            id: 'leonel',
                            name: 'Leonel Sidon',
                            email: 'sidonleonel@gmail.com',
                            phone: '(671) 747-1882',
                            specialties: 'Body Massages and Treatments (Sundays only)',
                            capabilities: ['massages', 'treatments'],
                            work_days: [0],
                            initials: 'LS'
                        }
                    ]);
                
                if (staffError) {
                    log(`‚ùå Error inserting staff: ${staffError.message}`, 'error');
                } else {
                    log('‚úÖ Staff data inserted successfully', 'success');
                }
                
                // Insert services (sample of key services)
                const services = [
                    // Facials
                    { id: 'basic_facial', name: 'Basic Facial', category: 'facials', duration: 30, price: 65, requires_room_3: false },
                    { id: 'deep_cleansing_facial', name: 'Deep Cleansing Facial', category: 'facials', duration: 60, price: 79, requires_room_3: false },
                    { id: 'microderm_facial', name: 'Microderm Facial', category: 'facials', duration: 60, price: 99, requires_room_3: false },
                    
                    // Massages
                    { id: 'balinese_massage', name: 'Balinese Body Massage', category: 'massages', duration: 60, price: 80, requires_room_3: false },
                    { id: 'deep_tissue_massage', name: 'Deep Tissue Body Massage', category: 'massages', duration: 60, price: 90, requires_room_3: false },
                    { id: 'hot_stone_massage', name: 'Hot Stone Massage', category: 'massages', duration: 60, price: 90, requires_room_3: false },
                    
                    // Treatments
                    { id: 'underarm_cleaning', name: 'Underarm Cleaning', category: 'treatments', duration: 30, price: 99, requires_room_3: true },
                    { id: 'back_treatment', name: 'Back Treatment', category: 'treatments', duration: 30, price: 99, requires_room_3: true },
                    
                    // Waxing
                    { id: 'eyebrow_waxing', name: 'Eyebrow Waxing', category: 'waxing', duration: 15, price: 20, requires_room_3: false },
                    { id: 'brazilian_wax_women', name: 'Brazilian Wax (Women)', category: 'waxing', duration: 45, price: 60, requires_room_3: false },
                    
                    // Packages
                    { id: 'balinese_facial_package', name: 'Balinese Body Massage + Basic Facial', category: 'packages', duration: 90, price: 130, requires_room_3: false, is_couples_service: true }
                ];
                
                const { error: servicesError } = await supabase
                    .from('services')
                    .upsert(services);
                
                if (servicesError) {
                    log(`‚ùå Error inserting services: ${servicesError.message}`, 'error');
                } else {
                    log('‚úÖ Services data inserted successfully', 'success');
                }
                
            } catch (error) {
                log(`‚ùå Error during data insertion: ${error.message}`, 'error');
            }
        }
        
        async function verifySchema() {
            if (!supabase) {
                if (!initializeSupabase()) return;
            }
            
            log('üîç Verifying schema creation...', 'info');
            
            try {
                // Check services
                const { count: servicesCount, error: servicesError } = await supabase
                    .from('services')
                    .select('*', { count: 'exact', head: true });
                
                // Check staff
                const { count: staffCount, error: staffError } = await supabase
                    .from('staff')
                    .select('*', { count: 'exact', head: true });
                
                // Check rooms
                const { count: roomsCount, error: roomsError } = await supabase
                    .from('rooms')
                    .select('*', { count: 'exact', head: true });
                
                if (servicesError || staffError || roomsError) {
                    log('‚ùå Error during verification', 'error');
                    return;
                }
                
                // Update stats display
                document.getElementById('servicesCount').textContent = servicesCount || 0;
                document.getElementById('staffCount').textContent = staffCount || 0;
                document.getElementById('roomsCount').textContent = roomsCount || 0;
                document.getElementById('tablesCount').textContent = '8'; // Core tables
                document.getElementById('statsContainer').style.display = 'grid';
                
                log(`‚úÖ Schema verification completed!`, 'success');
                log(`üìä Services: ${servicesCount}, Staff: ${staffCount}, Rooms: ${roomsCount}`, 'info');
                log('üåê Your Dermal Skin Clinic database is ready to use!', 'success');
                
            } catch (error) {
                log(`üí• Error during verification: ${error.message}`, 'error');
            }
        }
        
        // Initialize with sample data on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('üè• Dermal Skin Clinic Database Setup Tool', 'info');
            log('üìã Instructions:', 'info');
            log('1. Enter your Supabase URL and Service Role Key above', 'info');
            log('2. Click "Execute Schema" to create the database structure', 'info');
            log('3. Click "Verify Schema" to confirm everything was created correctly', 'info');
            log('', 'info');
            log('üîê Service Role Key Location:', 'warning');
            log('   Supabase Dashboard ‚Üí Settings ‚Üí API ‚Üí service_role (secret)', 'warning');
            log('', 'info');
        });
    </script>
</body>
</html>