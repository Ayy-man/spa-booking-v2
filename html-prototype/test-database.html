<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dermal Skin Clinic - Database Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #2c5282;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.loading {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background-color: #45a049;
        }
        .test-results {
            max-height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dermal Skin Clinic - Database Connection Test</h1>
        <p>This page tests the connection to your Supabase database and verifies that all tables and functions are working correctly.</p>
        
        <div class="test-section">
            <h3>Connection Status</h3>
            <div id="connection-status" class="status loading">Testing connection...</div>
            <button onclick="testConnection()">Test Connection</button>
        </div>
        
        <div class="test-section">
            <h3>Services Data</h3>
            <div id="services-status" class="status">Not tested yet</div>
            <button onclick="testServices()">Load Services</button>
            <div id="services-results" class="test-results" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>Staff Data</h3>
            <div id="staff-status" class="status">Not tested yet</div>
            <button onclick="testStaff()">Load Staff</button>
            <div id="staff-results" class="test-results" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>Rooms Data</h3>
            <div id="rooms-status" class="status">Not tested yet</div>
            <button onclick="testRooms()">Load Rooms</button>
            <div id="rooms-results" class="test-results" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>Availability Function Test</h3>
            <div id="availability-status" class="status">Not tested yet</div>
            <button onclick="testAvailability()">Test Availability Check</button>
            <div id="availability-results" class="test-results" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>Customer Operations Test</h3>
            <div id="customer-status" class="status">Not tested yet</div>
            <button onclick="testCustomer()">Test Customer Creation</button>
            <div id="customer-results" class="test-results" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>Dashboard Metrics Test</h3>
            <div id="metrics-status" class="status">Not tested yet</div>
            <button onclick="testMetrics()">Load Dashboard Metrics</button>
            <div id="metrics-results" class="test-results" style="display: none;"></div>
        </div>
    </div>

    <!-- Load Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Load our database client -->
    <script src="js/supabase-client.js"></script>
    
    <script>
        // Initialize Supabase client
        const supabase = window.supabase.createClient(
            'https://doradsvnphdwotkeiylv.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRvcmFkc3ZucGhkd290a2VpeWx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3NDA3MTYsImV4cCI6MjA2OTMxNjcxNn0.4DbNHxjhOshrrQGYxjH8QI4V2sqx2VLr7nH0stSEXZk'
        );
        
        // Test functions
        async function testConnection() {
            const statusEl = document.getElementById('connection-status');
            statusEl.className = 'status loading';
            statusEl.textContent = 'Testing connection...';
            
            try {
                const { data, error } = await supabase
                    .from('services')
                    .select('count')
                    .limit(1);
                
                if (error) throw error;
                
                statusEl.className = 'status success';
                statusEl.textContent = 'Connection successful! Database is accessible.';
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `Connection failed: ${error.message}`;
            }
        }
        
        async function testServices() {
            const statusEl = document.getElementById('services-status');
            const resultsEl = document.getElementById('services-results');
            
            statusEl.className = 'status loading';
            statusEl.textContent = 'Loading services...';
            resultsEl.style.display = 'none';
            
            try {
                const services = await DermalSpaDB.getServices();
                
                statusEl.className = 'status success';
                statusEl.textContent = `Successfully loaded ${services.length} services`;
                
                // Group by category
                const categories = {};
                services.forEach(service => {
                    if (!categories[service.category]) {
                        categories[service.category] = [];
                    }
                    categories[service.category].push(service);
                });
                
                let html = '<h4>Services by Category:</h4>';
                for (const [category, categoryServices] of Object.entries(categories)) {
                    html += `<strong>${category.toUpperCase()}</strong>: ${categoryServices.length} services<br>`;
                    categoryServices.forEach(service => {
                        html += `- ${service.name} (${service.duration}min, $${service.price})<br>`;
                    });
                    html += '<br>';
                }
                
                resultsEl.innerHTML = html;
                resultsEl.style.display = 'block';
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `Error loading services: ${error.message}`;
            }
        }
        
        async function testStaff() {
            const statusEl = document.getElementById('staff-status');
            const resultsEl = document.getElementById('staff-results');
            
            statusEl.className = 'status loading';
            statusEl.textContent = 'Loading staff...';
            resultsEl.style.display = 'none';
            
            try {
                const staff = await DermalSpaDB.getStaff();
                
                statusEl.className = 'status success';
                statusEl.textContent = `Successfully loaded ${staff.length} staff members`;
                
                let html = '<h4>Staff Members:</h4>';
                staff.forEach(member => {
                    const workDays = member.work_days.map(day => {
                        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                        return days[day];
                    }).join(', ');
                    
                    html += `<strong>${member.name}</strong> (${member.initials})<br>`;
                    html += `- Capabilities: ${member.capabilities.join(', ')}<br>`;
                    html += `- Work Days: ${workDays}<br>`;
                    html += `- Specialties: ${member.specialties}<br><br>`;
                });
                
                resultsEl.innerHTML = html;
                resultsEl.style.display = 'block';
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `Error loading staff: ${error.message}`;
            }
        }
        
        async function testRooms() {
            const statusEl = document.getElementById('rooms-status');
            const resultsEl = document.getElementById('rooms-results');
            
            statusEl.className = 'status loading';
            statusEl.textContent = 'Loading rooms...';
            resultsEl.style.display = 'none';
            
            try {
                const rooms = await DermalSpaDB.getRooms();
                
                statusEl.className = 'status success';
                statusEl.textContent = `Successfully loaded ${rooms.length} rooms`;
                
                let html = '<h4>Room Configuration:</h4>';
                rooms.forEach(room => {
                    html += `<strong>${room.name}</strong><br>`;
                    html += `- Capacity: ${room.capacity} people<br>`;
                    html += `- Capabilities: ${room.capabilities.join(', ')}<br><br>`;
                });
                
                resultsEl.innerHTML = html;
                resultsEl.style.display = 'block';
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `Error loading rooms: ${error.message}`;
            }
        }
        
        async function testAvailability() {
            const statusEl = document.getElementById('availability-status');
            const resultsEl = document.getElementById('availability-results');
            
            statusEl.className = 'status loading';
            statusEl.textContent = 'Testing availability function...';
            resultsEl.style.display = 'none';
            
            try {
                // Test availability for a facial service tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const dateStr = tomorrow.toISOString().split('T')[0];
                
                const availability = await DermalSpaDB.getServiceAvailability('basic_facial', dateStr);
                
                statusEl.className = 'status success';
                statusEl.textContent = `Availability check successful - found ${availability.length} available slots`;
                
                let html = `<h4>Availability for Basic Facial on ${dateStr}:</h4>`;
                if (availability.length === 0) {
                    html += 'No available slots found.<br>';
                } else {
                    availability.forEach(slot => {
                        html += `<strong>${slot.staff_name}</strong> in ${slot.room_name}<br>`;
                        if (slot.available_slots && slot.available_slots.length > 0) {
                            html += `Available times: ${slot.available_slots.length} slots<br>`;
                        } else {
                            html += 'No specific time slots returned<br>';
                        }
                        html += '<br>';
                    });
                }
                
                resultsEl.innerHTML = html;
                resultsEl.style.display = 'block';
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `Availability test failed: ${error.message}`;
            }
        }
        
        async function testCustomer() {
            const statusEl = document.getElementById('customer-status');
            const resultsEl = document.getElementById('customer-results');
            
            statusEl.className = 'status loading';
            statusEl.textContent = 'Testing customer creation...';
            resultsEl.style.display = 'none';
            
            try {
                // Create a test customer
                const testCustomer = {
                    firstName: 'Jane',
                    lastName: 'Doe',
                    phone: '(555) 123-4567',
                    email: 'jane.doe@example.com',
                    marketingConsent: true
                };
                
                const customerId = await DermalSpaDB.upsertCustomer(testCustomer);
                
                // Retrieve the customer
                const customer = await DermalSpaDB.getCustomer(customerId);
                
                statusEl.className = 'status success';
                statusEl.textContent = 'Customer creation and retrieval successful';
                
                let html = '<h4>Test Customer Created:</h4>';
                html += `<strong>Name:</strong> ${customer.first_name} ${customer.last_name}<br>`;
                html += `<strong>Phone:</strong> ${customer.phone}<br>`;
                html += `<strong>Email:</strong> ${customer.email}<br>`;
                html += `<strong>Customer ID:</strong> ${customer.id}<br>`;
                html += `<strong>Created At:</strong> ${new Date(customer.created_at).toLocaleString()}<br>`;
                
                resultsEl.innerHTML = html;
                resultsEl.style.display = 'block';
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `Customer test failed: ${error.message}`;
            }
        }
        
        async function testMetrics() {
            const statusEl = document.getElementById('metrics-status');
            const resultsEl = document.getElementById('metrics-results');
            
            statusEl.className = 'status loading';
            statusEl.textContent = 'Loading dashboard metrics...';
            resultsEl.style.display = 'none';
            
            try {
                const metrics = await DermalSpaDB.getDashboardMetrics();
                
                statusEl.className = 'status success';
                statusEl.textContent = 'Dashboard metrics loaded successfully';
                
                let html = '<h4>Dashboard Metrics:</h4>';
                html += `<strong>Today:</strong><br>`;
                html += `- Bookings: ${metrics.today.bookings}<br>`;
                html += `- Completed: ${metrics.today.completed}<br>`;
                html += `- Cancelled: ${metrics.today.cancelled}<br>`;
                html += `- Revenue: $${metrics.today.revenue}<br><br>`;
                
                html += `<strong>This Week:</strong><br>`;
                html += `- Bookings: ${metrics.week.bookings}<br>`;
                html += `- Revenue: $${metrics.week.revenue}<br><br>`;
                
                html += `<strong>This Month:</strong><br>`;
                html += `- Bookings: ${metrics.month.bookings}<br>`;
                html += `- Revenue: $${metrics.month.revenue}<br><br>`;
                
                html += `<em>Generated at: ${new Date(metrics.generated_at).toLocaleString()}</em>`;
                
                resultsEl.innerHTML = html;
                resultsEl.style.display = 'block';
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `Metrics test failed: ${error.message}`;
            }
        }
        
        // Run connection test on page load
        window.addEventListener('load', () => {
            setTimeout(testConnection, 1000);
        });
    </script>
</body>
</html>